<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spiderdt.mars.dao.SubplanDao">

    <select id="queryLastMonthAvg" resultType="hashmap">
        WITH A AS (
        SELECT ppg_id FROM stg.mars_${data_source}_promo_scaledrd_date
        <choose>
            <when test="var != 'category_1'">
                WHERE
                <foreach item="c_list" collection="list" open="" separator="and" close="">
                    ${c_list}
                </foreach>
            </when>
        </choose>
        )
        SELECT
        avg(exp(reduced.coef_model1_coupon * pred.coupon))             AS effect_coupon,
        avg(exp(reduced.coef_model1_debut * pred.debut))               AS effect_debut,
        avg(exp(reduced.coef_model1_discount * pred.discount))         AS effect_discount,
        avg(exp(reduced.coef_model1_ln_baseprice * pred.ln_baseprice)) AS effect_ln_baseprice
        FROM stg.mars_${data_source}_preddata pred LEFT JOIN stg.mars_${data_source}_coeffs_final_reduced reduced
        ON pred.ppg_id = reduced.ppg_id
        WHERE pred.ppg_id IN (SELECT ppg_id FROM A)
        AND date > #{last_date}::TIMESTAMP + interval '-1 month'

    </select>


</mapper>